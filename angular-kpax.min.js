/*! angular-kpax.min.js build:0.0.5. Copyright(c) 2014 Dg Nechtan http://hax0r.in MIT Licensed */ angular.module("ngSocketIO",[]).provider("ioFactory",function(){"use strict";var n="socket:";this.$get=["$rootScope","$timeout",function(a,e){var t=function(n,a){return a?function(){var t=arguments;e(function(){a.apply(n,t)},0)}:angular.noop};return function(e){e=e||{};var r=e.ioSocket||io.connect(),o=e.prefix||n,c=e.scope||a;r.on("error",function(n){/handshake/.test(n)&&(console.log("handshake error"),r.disconnect(),e.failureRedirect&&(window.location.href=e.failureRedirect))});var s=function(n,a){r.on(n,t(r,a))},u={on:s,addListener:s,emit:function(n,a,e){return r.emit(n,a,t(r,e))},removeListener:function(){return r.removeListener.apply(r,arguments)},forward:function(n,a){n instanceof Array==!1&&(n=[n]),a||(a=c),n.forEach(function(n){var e=o+n,c=t(r,function(n){a.$broadcast(e,n)});a.$on("$destroy",function(){r.removeListener(n,c)}),r.on(n,c)})}};return u}}]}),angular.module("ngKpax",["ngSocketIO"]).constant("KPAX_SCHEMA","kpax:").constant("KPAX_VERSION","0.0.1").factory("kpax",["ioFactory","KPAX_SCHEMA","KPAX_VERSION","$cacheFactory","$timeout",function(n,a,e,t,r){"use strict";var o=n({failureRedirect:"/login"}),c=t("kpax"),s={},u={},i=["get","head"],h=["post","delete","del","put"],l=i.concat(h),p=function(n){return"_".concat(n||"",new Date*(e+Math.random()).replace(/\D/g,""),Math.random().toString(36))},f=function(n,a){angular.isFunction(a)&&(a=[a]),a||(a=[]),n=angular.extend({cache:!~h.indexOf(n.method||"get"),method:"get",url:"",params:{},data:{}},n||{});var e=!1,t=p(n.method+":"+n.url);if(n.cache){var r=JSON.stringify([n.method,n.url,n.params]);if(e=c.get(r)){for(var u=0;u<a.length;u++)a[u](e.data);return e._hash}}return angular.isFunction(n.success)&&a.push(n.success),s[t]=a,o.emit("kpax",{_hash:t,_key:n.method+":"+n.url,_cache:[n.cache,r],to:n.hasOwnProperty("to")?n.to:null,params:n.params}),t},g=function(n,a,e){if(angular.isFunction(e)&&(e=[e]),e||(e=[]),angular.isObject(n)){var t=n;angular.isFunction(a)?(e.push(a),a=""):(angular.isArray(a)&&(e=e.concat(a),a=""),t.hasOwnProperty("success")&&e.push(t.success),t.hasOwnProperty("complete")&&e.push(t.success)),t.hasOwnProperty("type")&&(n=t.type),t.hasOwnProperty("method")&&(n=t.method),t.hasOwnProperty("url")&&(a=t.url)}var r=n+":"+a;console.log("set $on",r,e),angular.isArray(s[r])||(s[r]=[]),s[r]=s[r].concat(e)};return o.on("kpax",function(n){if(console.log("on kpax",n),s.hasOwnProperty(n._key)){console.log("$on _key",n._key);var a=function(a){o.emit("kpax",{_hash:n._hash,_key:n._key,data:a})};s[n._key].length||(s[n._key]=[s[n._key]]);for(var e=0,t=s[n._key].length;t>e;e++)angular.isFunction(s[n._key][e])&&s[n._key][e].call(o,n,{send:a,emit:a,json:a});return!0}if(s.hasOwnProperty(n._hash)&&angular.isFunction(s[n._hash])&&(s[n._hash]=[s[n._hash]]),s[n._hash]&&s[n._hash].length){angular.isArray(n._cache)&&n._cache[0]&&(c.put(n._cache[1],n),angular.isNumber(n._cache[0])&&n._cache[0]>0&&r(function(){c.remove(n._cache[1])},n._cache[0]));for(var e=0;e<s[n._hash].length;e++)angular.isFunction(s[n._hash][e])&&s[n._hash][e](n.data);s[n._hash]=null}}),l.map(function(n){u[n]=function(a,e,t,r){angular.isFunction(r)&&(r=[r]),r||(r=[]),angular.isObject(a)?(angular.isFunction(a.success)&&r.push(a.success),angular.isFunction(a.complete)&&r.push(a.complete),angular.isFunction(e)&&r.push(e),f(a,r)):(angular.isFunction(t)&&(r.push(t),t={}),f({url:a,method:n,params:t,data:e},r))}}),u.on=g.bind(o),u.emit=u.send=f.bind(o),u.socket=o,u.cache=c,u.identify=function(n){return o.emit("kpax:identify",n),u},u}]);